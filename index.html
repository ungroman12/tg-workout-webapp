<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#121824;
      --card2:#0f1520;
      --text:#eaf0ff;
      --muted:#a7b1c6;
      --line:rgba(255,255,255,.09);
      --accent:#2f7cf6;
      --accent2:#1659c8;
      --good:#19c37d;
      --bad:#ff5c5c;
      --shadow:0 16px 40px rgba(0,0,0,.35);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 10% 0%, rgba(47,124,246,.18), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(25,195,125,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      padding-bottom:96px;
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px}
    .topbar{
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;
      margin-top:6px;margin-bottom:14px;
    }
    .h1{font-size:34px;font-weight:900;letter-spacing:.2px;line-height:1}
    .sub{color:var(--muted);font-size:13px;margin-top:6px}
   .datepill{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  border-radius:18px;
  padding:10px 10px;
  display:flex;
  align-items:center;
  gap:10px;

  /* —á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ–∑–∞–ª–æ –≤–ø—Ä–∞–≤–æ */
  min-width:0;
  width:200px;
  max-width:42vw;

  box-shadow:var(--shadow);
    }
    .iconbtn{
      width:36px;height:36px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.15);
      color:var(--text);
      font-size:18px;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
    }
   .datecenter{
  flex:1;
  min-width:0;
  text-align:center;
}

.datecenter .big,
.datecenter .small{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.datecenter .big{
  font-weight:900;
}

.datecenter .small{
  color:var(--muted);
  font-size:12px;
  margin-top:2px;
}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}

    .hero{
      border-radius:26px;
      overflow:hidden;
      border:1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.55)),
        url("https://images.unsplash.com/photo-1517836357463-d25dfeac3438?auto=format&fit=crop&w=1200&q=60");
      background-size:cover;
      background-position:center;
      box-shadow:var(--shadow);
      min-height:184px;
      display:flex;
      align-items:flex-end;
      padding:16px;
    }
    .heroTitle{font-size:28px;font-weight:900}
    .heroMeta{color:rgba(255,255,255,.78);margin-top:6px}

    .statsCard{
      background: linear-gradient(180deg, rgba(47,124,246,.92), rgba(22,89,200,.92));
      border-radius:26px;
      border:1px solid rgba(255,255,255,.18);
      padding:14px 14px;
      box-shadow:var(--shadow);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .statsCard .k{font-size:13px;opacity:.9}
    .statsCard .v{font-size:26px;font-weight:900;margin-top:3px}
    .statsCard .s{font-size:13px;opacity:.9;margin-top:2px}
    .shareBtn{
      width:44px;height:44px;border-radius:16px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      color:white;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      font-size:18px;
    }

    .card{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .cardTitle{font-size:16px;font-weight:900;margin:0 0 8px 0}
    .muted{color:var(--muted)}

    .workoutList{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .wItem{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
    }
    .wLeft{display:flex;flex-direction:column;gap:4px}
    .wName{font-weight:900}
    .wSmall{color:var(--muted);font-size:12px}
    .wGo{
      width:38px;height:38px;border-radius:16px;
      background:rgba(47,124,246,.18);
      border:1px solid rgba(47,124,246,.35);
      color:var(--text);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      font-size:18px;
      flex:0 0 auto;
    }

    .primaryBtn{
      width:100%;
      margin-top:12px;
      background:linear-gradient(180deg, var(--accent), var(--accent2));
      color:white;
      border:0;
      padding:14px 16px;
      border-radius:18px;
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      box-shadow: 0 14px 30px rgba(47,124,246,.25);
    }
    .ghostBtn{
      width:100%;
      margin-top:10px;
      background:rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid var(--line);
      padding:12px 14px;
      border-radius:18px;
      font-size:14px;
      font-weight:800;
      cursor:pointer;
    }

    /* Bottom tabs */
    .tabs{
      position:fixed;left:0;right:0;bottom:0;
      padding:12px 12px 18px;
      background:rgba(10,14,20,.82);
      backdrop-filter: blur(12px);
      border-top:1px solid var(--line);
    }
    .tabs .inner{
      max-width:980px;margin:0 auto;
      display:flex;gap:10px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:22px;
      padding:8px;
      box-shadow:var(--shadow);
    }
    .tab{
      flex:1;
      border:0;
      background:transparent;
      color:var(--muted);
      padding:10px 10px;
      border-radius:16px;
      font-weight:900;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:8px;
    }
    .tab.active{
      background:rgba(47,124,246,.18);
      color:var(--text);
      border:1px solid rgba(47,124,246,.28);
    }

    /* Screens */
    .screen{display:none}
    .screen.active{display:block}

    /* Editor */
    .sheet{
      position:fixed;left:0;right:0;top:0;bottom:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      padding:12px;
      z-index:20;
    }
    .sheet.show{display:flex}
    .sheetInner{
      width:100%;
      max-width:980px;
      margin:0 auto;
      background:rgba(18,24,36,.96);
      border:1px solid var(--line);
      border-radius:26px;
      box-shadow:var(--shadow);
      padding:14px;
      max-height:88vh;
      overflow:auto;
    }
    .sheetTop{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .sheetTop .ttl{font-weight:900;font-size:18px}
    .xbtn{
      width:38px;height:38px;border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-size:18px;
      display:flex;align-items:center;justify-content:center;
    }
    .field{
      display:flex;flex-direction:column;gap:6px;margin-top:10px
    }
    .field label{font-size:12px;color:var(--muted);font-weight:800}
    input, select{
      background:rgba(0,0,0,.22);
      border:1px solid var(--line);
      color:var(--text);
      padding:12px 12px;
      border-radius:16px;
      outline:none;
      font-weight:800;
      font-size:14px;
    }
    .exList{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .exCard{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
    }
    .exHead{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .exHead .name{flex:1}
    .mini{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:14px;
      padding:10px 10px;
      font-weight:900;
      cursor:pointer;
    }
    .mini.danger{border-color:rgba(255,92,92,.35);background:rgba(255,92,92,.12)}
    .sets{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .setRow{
      display:grid;
      grid-template-columns: 1fr 1fr auto;
      gap:8px;
      align-items:center;
    }
    .setRow input{padding:10px 10px;border-radius:14px}
    .delSet{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,92,92,.35);
      background:rgba(255,92,92,.12);
      color:var(--text);
      cursor:pointer;
      font-size:16px;
      display:flex;align-items:center;justify-content:center;
    }
    .sheetActions{display:flex;gap:10px;margin-top:12px}
    .sheetActions .primaryBtn{margin-top:0}
    .sheetActions .ghostBtn{margin-top:0}

    /* Progress */
    canvas{width:100%;height:220px;background:rgba(0,0,0,.14);border:1px solid var(--line);border-radius:18px}
    .chipRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      font-size:12px;
      opacity:.9;
    }
    .chip.active{background:rgba(47,124,246,.18);border-color:rgba(47,124,246,.35)}
.pill{
  min-width:0;
  overflow:hidden;
}
.pill button{
  flex: 0 0 44px;
}

/* fix: —á—Ç–æ–±—ã –±–ª–æ–∫ –¥–∞—Ç—ã –Ω–µ –≤—ã–ª–µ–∑–∞–ª –∑–∞ —ç–∫—Ä–∞–Ω */
.pill{
  width: 100%;
  max-width: 100%;
  min-width: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  overflow: hidden;           /* –≤–∞–∂–Ω–æ */
}

/* —Ü–µ–Ω—Ç—Ä —Ä–µ–∞–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä, –∏ –Ω–µ —Ä–∞—Å—à–∏—Ä—è–µ—Ç pill */
.pill .center{
  flex: 1 1 auto;
  min-width: 0;               /* –≤–∞–∂–Ω–æ */
  text-align: center;
}

/* —Å—Ç—Ä–æ–∫–∏ –≤–Ω—É—Ç—Ä–∏ –Ω–µ –ª–æ–º–∞—é—Ç —à–∏—Ä–∏–Ω—É */
.pill .center > div{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* –º–æ–±–∏–ª–∫–∞: –≤–µ—Ä—Ö –≤ –∫–æ–ª–æ–Ω–∫—É, pill –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
@media (max-width: 520px){
  .top{
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
  .pill{
    width: 100%;
  }
}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- WORKOUTS SCREEN -->
    <section id="screen-workouts" class="screen active">
      <div class="topbar">
        <div>
          <div class="h1">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
          <div class="sub">–¥–Ω–µ–≤–Ω–∏–∫ ‚Ä¢ –∫–∞–ª–µ–Ω–¥–∞—Ä—å ‚Ä¢ –ø—Ä–æ–≥—Ä–µ—Å—Å</div>
        </div>

        <div class="datepill">
          <button class="iconbtn" id="prevDay" aria-label="prev">‚Äπ</button>
          <div class="datecenter">
            <div class="big" id="dateTitle">–°–µ–≥–æ–¥–Ω—è</div>
            <div class="small" id="dateSubtitle">‚Äî</div>
          </div>
          <button class="iconbtn" id="nextDay" aria-label="next">‚Ä∫</button>
        </div>
      </div>

      <div class="grid">
        <div class="hero">
          <div>
            <div class="heroTitle" id="heroWorkoutName">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–Ω—è</div>
            <div class="heroMeta" id="heroWorkoutMeta">–î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</div>
          </div>
        </div>

        <div class="statsCard">
          <div>
            <div class="k">–í—Å–µ–≥–æ</div>
            <div class="v"><span id="statWorkouts">0</span> —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
            <div class="s">–ü–æ–¥–Ω—è—Ç—ã–π –≤–µ—Å: <b id="statVolume">0</b> –∫–≥</div>
          </div>
          <button class="shareBtn" id="shareBtn" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">‚§¥Ô∏é</button>
        </div>

        <div class="card">
          <div class="cardTitle">–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</div>
          <div class="muted" id="emptyHint">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏ ‚ÄúÔºã –ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞‚Äù.</div>

          <div class="workoutList" id="workoutList"></div>

          <button class="primaryBtn" id="newWorkoutBtn">Ôºã –ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
          <button class="ghostBtn" id="sendToBotBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–æ—Ç–µ (tg.sendData)</button>
        </div>
      </div>
    </section>

    <!-- CALENDAR SCREEN -->
    <section id="screen-calendar" class="screen">
      <div class="topbar">
        <div>
          <div class="h1">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
          <div class="sub">–±—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –¥–∞—Ç—ã –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä</div>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É</div>
        <div class="field">
          <label>–î–∞—Ç–∞</label>
          <input type="date" id="datePicker">
        </div>

        <button class="primaryBtn" id="goToDateBtn">–û—Ç–∫—Ä—ã—Ç—å –¥–∞—Ç—É</button>
        <div class="muted" style="margin-top:10px">–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏/–∏–ª–∏ –≤ –±–æ—Ç–µ (workouts.json).</div>
      </div>
    </section>

    <!-- PROGRESS SCREEN -->
    <section id="screen-progress" class="screen">
      <div class="topbar">
        <div>
          <div class="h1">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
          <div class="sub">—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º</div>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">–í—Å–µ–≥–æ</div>
        <div class="statsCard" style="box-shadow:none;border:1px solid var(--line)">
          <div>
            <div class="k">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ø–æ–∫–∞ –æ—Ü–µ–Ω–∫–∞)</div>
            <div class="v"><span id="pDuration">0</span> –º–∏–Ω</div>
            <div class="s">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: <b id="pCount">0</b> ‚Ä¢ –ü–æ–¥–Ω—è—Ç—ã–π –≤–µ—Å: <b id="pVolume">0</b> –∫–≥</div>
          </div>
          <button class="shareBtn" id="exportHintBtn" title="–≠–∫—Å–ø–æ—Ä—Ç">‚á©</button>
        </div>

        <div class="cardTitle" style="margin-top:14px">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>

        <div class="chipRow">
          <button class="chip active" data-range="30">1–ú</button>
          <button class="chip" data-range="90">3–ú</button>
          <button class="chip" data-range="180">6–ú</button>
          <button class="chip" data-range="365">1–ì</button>
          <button class="chip" data-range="9999">–í–°–ï</button>
        </div>

        <div style="margin-top:12px">
          <canvas id="chart" width="900" height="260"></canvas>
          <div class="muted" style="margin-top:10px">–ì—Ä–∞—Ñ–∏–∫: –∫–æ–ª-–≤–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ –¥–Ω—è–º (—É–ø—Ä–æ—â—ë–Ω–Ω–æ).</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS SCREEN -->
    <section id="screen-settings" class="screen">
      <div class="topbar">
        <div>
          <div class="h1">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          <div class="sub">—ç–∫—Å–ø–æ—Ä—Ç / –æ—á–∏—Å—Ç–∫–∞ / –æ—Ç–ª–∞–¥–∫–∞</div>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">–•—Ä–∞–Ω–∏–ª–∏—â–µ</div>
        <button class="ghostBtn" id="clearLocalBtn">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (localStorage)</button>
        <button class="ghostBtn" id="requestExportBtn">üì¶ –ü–æ–ø—Ä–æ—Å–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç —É –±–æ—Ç–∞ (tg.sendData)</button>
        <div class="muted" style="margin-top:10px">
          –≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω –∫–æ–º–∞–Ω–¥–æ–π –±–æ—Ç–∞ <b>/export</b>.
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="cardTitle">–û—Ç–ª–∞–¥–∫–∞</div>
        <div class="muted" id="debugBox">‚Äî</div>
      </div>
    </section>

  </div>

  <!-- Bottom Tabs -->
  <div class="tabs">
    <div class="inner">
      <button class="tab active" data-tab="workouts">üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</button>
      <button class="tab" data-tab="calendar">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
      <button class="tab" data-tab="progress">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å</button>
      <button class="tab" data-tab="settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
  </div>

  <!-- Editor Sheet -->
  <div class="sheet" id="sheet">
    <div class="sheetInner">
      <div class="sheetTop">
        <div class="ttl">–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div>
        <button class="xbtn" id="closeSheet">‚úï</button>
      </div>

      <div class="field">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input id="wTitle" placeholder="–ù–∞–ø—Ä: –ì—Ä—É–¥—å + —Ç—Ä–∏—Ü–µ–ø—Å">
      </div>

      <div class="field">
        <label>–î–∞—Ç–∞</label>
        <input id="wDate" type="date">
      </div>

      <div class="exList" id="exList"></div>

      <button class="ghostBtn" id="addExerciseBtn">Ôºã –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>

      <div class="sheetActions">
        <button class="ghostBtn" id="draftBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ</button>
        <button class="primaryBtn" id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –±–æ—Ç–∞</button>
      </div>

      <div class="muted" style="margin-top:10px">
        –õ–æ–∫–∞–ª—å–Ω–æ = –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage). –í –±–æ—Ç–µ = –∑–∞–ø–∏—Å—å –≤ workouts.json —á–µ—Ä–µ–∑ tg.sendData.
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Telegram init
    // -----------------------------
    const TG = window.Telegram?.WebApp;
    try {
      TG?.ready();
      TG?.expand();
      // –ø—Ä–∏—è—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ –≤ Telegram
      if (TG?.setHeaderColor) TG.setHeaderColor({ color: "#0b0f14" });
      if (TG?.setBackgroundColor) TG.setBackgroundColor({ color: "#0b0f14" });
    } catch (e) {}

    const debugBox = document.getElementById('debugBox');
    function debug(msg){
      debugBox.textContent = String(msg);
    }
    debug("WebApp loaded. " + (TG ? "Telegram WebApp detected." : "No TG object (opened in browser)."));

    // -----------------------------
    // Data model
    // workout = { id, date(YYYY-MM-DD), title, exercises:[{name, sets:[{w,r}]}], createdAt }
    // -----------------------------
    const LS_KEY = "workout_diary_v1";
    function loadLocal(){
      try {
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }
    function saveLocal(all){
      localStorage.setItem(LS_KEY, JSON.stringify(all));
    }
    function uid(){
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }
    function todayISO(){
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60*1000);
      return local.toISOString().slice(0,10);
    }
    function fmtDateTitle(iso){
      const t = todayISO();
      if (iso === t) return "–°–µ–≥–æ–¥–Ω—è";
      const d = new Date(iso + "T00:00:00");
      return d.toLocaleDateString("ru-RU", { weekday:"short", day:"numeric", month:"short" });
    }
    function fmtDateSub(iso){
      const d = new Date(iso + "T00:00:00");
      return d.toLocaleDateString("ru-RU", { weekday:"long", day:"numeric", month:"long" });
    }

    // -----------------------------
    // State
    // -----------------------------
    let allWorkouts = loadLocal();
    let selectedDate = todayISO();
    let draft = null; // current editor draft
    let chartRangeDays = 30;

    // -----------------------------
    // Tabs
    // -----------------------------
    const screens = {
      workouts: document.getElementById("screen-workouts"),
      calendar: document.getElementById("screen-calendar"),
      progress: document.getElementById("screen-progress"),
      settings: document.getElementById("screen-settings"),
    };

    function setTab(tab){
      document.querySelectorAll(".tab").forEach(b=>{
        b.classList.toggle("active", b.dataset.tab === tab);
      });
      Object.keys(screens).forEach(k=>{
        screens[k].classList.toggle("active", k === tab);
      });
      if(tab === "progress") renderProgress();
      if(tab === "calendar") syncDatePicker();
    }

    document.querySelectorAll(".tab").forEach(b=>{
      b.addEventListener("click", ()=> setTab(b.dataset.tab));
    });

    // -----------------------------
    // Header date controls
    // -----------------------------
    const dateTitle = document.getElementById("dateTitle");
    const dateSubtitle = document.getElementById("dateSubtitle");
    const prevDay = document.getElementById("prevDay");
    const nextDay = document.getElementById("nextDay");

    function shiftDay(n){
      const d = new Date(selectedDate + "T00:00:00");
      d.setDate(d.getDate() + n);
      selectedDate = d.toISOString().slice(0,10);
      renderWorkouts();
    }
    prevDay.addEventListener("click", ()=>shiftDay(-1));
    nextDay.addEventListener("click", ()=>shiftDay(1));

    // -----------------------------
    // Workout list screen
    // -----------------------------
    const workoutList = document.getElementById("workoutList");
    const emptyHint = document.getElementById("emptyHint");
    const heroWorkoutName = document.getElementById("heroWorkoutName");
    const heroWorkoutMeta = document.getElementById("heroWorkoutMeta");

    const statWorkouts = document.getElementById("statWorkouts");
    const statVolume = document.getElementById("statVolume");

    function calcWorkoutVolume(w){
      let sum = 0;
      for(const ex of (w.exercises||[])){
        for(const s of (ex.sets||[])){
          const ww = Number(s.w||0);
          const rr = Number(s.r||0);
          sum += ww * rr;
        }
      }
      return Math.round(sum);
    }

    function workoutsByDate(iso){
      return allWorkouts
        .filter(w => w.date === iso)
        .sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));
    }

    function renderWorkouts(){
      dateTitle.textContent = fmtDateTitle(selectedDate);
      dateSubtitle.textContent = fmtDateSub(selectedDate);

      const todays = workoutsByDate(selectedDate);

      workoutList.innerHTML = "";
      emptyHint.style.display = todays.length ? "none" : "block";

      if(!todays.length){
        heroWorkoutName.textContent = "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–Ω—è";
        heroWorkoutMeta.textContent = "–î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É";
      } else {
        const w0 = todays[0];
        heroWorkoutName.textContent = w0.title || "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞";
        const exCount = (w0.exercises||[]).length;
        heroWorkoutMeta.textContent = `${exCount} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π ‚Ä¢ –æ–±—ä—ë–º ${calcWorkoutVolume(w0)} –∫–≥`;
      }

      for(const w of todays){
        const exCount = (w.exercises||[]).length;
        const vol = calcWorkoutVolume(w);
        const div = document.createElement("div");
        div.className = "wItem";
        div.innerHTML = `
          <div class="wLeft">
            <div class="wName">${escapeHtml(w.title || "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞")}</div>
            <div class="wSmall">${exCount} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π ‚Ä¢ ${vol} –∫–≥</div>
          </div>
          <button class="wGo" title="–û—Ç–∫—Ä—ã—Ç—å">‚Ä∫</button>
        `;
        div.querySelector(".wGo").addEventListener("click", ()=>openEditor(w));
        workoutList.appendChild(div);
      }

      // global stats
      statWorkouts.textContent = allWorkouts.length;
      statVolume.textContent = allWorkouts.reduce((acc,w)=>acc+calcWorkoutVolume(w),0);
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // -----------------------------
    // Editor sheet
    // -----------------------------
    const sheet = document.getElementById("sheet");
    const closeSheet = document.getElementById("closeSheet");
    const newWorkoutBtn = document.getElementById("newWorkoutBtn");
    const sendToBotBtn = document.getElementById("sendToBotBtn");

    const wTitle = document.getElementById("wTitle");
    const wDate = document.getElementById("wDate");
    const exList = document.getElementById("exList");
    const addExerciseBtn = document.getElementById("addExerciseBtn");
    const draftBtn = document.getElementById("draftBtn");
    const saveBtn = document.getElementById("saveBtn");

    function openSheet(){
      sheet.classList.add("show");
      if (TG?.HapticFeedback) TG.HapticFeedback.impactOccurred("light");
    }
    function closeSheetFn(){
      sheet.classList.remove("show");
    }
    closeSheet.addEventListener("click", closeSheetFn);
    sheet.addEventListener("click", (e)=>{ if(e.target === sheet) closeSheetFn(); });

    function newDraft(dateISO){
      return {
        id: uid(),
        date: dateISO,
        title: "",
        exercises: [],
        createdAt: Date.now(),
      };
    }

    function openEditor(existing){
      draft = existing ? JSON.parse(JSON.stringify(existing)) : newDraft(selectedDate);
      wTitle.value = draft.title || "";
      wDate.value = draft.date || selectedDate;
      renderExercises();
      openSheet();
    }

    newWorkoutBtn.addEventListener("click", ()=> openEditor(null));

    addExerciseBtn.addEventListener("click", ()=>{
      draft.exercises.push({ name:"", sets:[{w:"", r:""}] });
      renderExercises();
    });

    function renderExercises(){
      exList.innerHTML = "";
      (draft.exercises||[]).forEach((ex, idx)=>{
        const exDiv = document.createElement("div");
        exDiv.className = "exCard";
        exDiv.innerHTML = `
          <div class="exHead">
            <input class="name" placeholder="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ (–Ω–∞–ø—Ä: –ñ–∏–º –ª—ë–∂–∞)" value="${escapeHtml(ex.name||"")}">
            <button class="mini danger" title="–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ">–£–¥–∞–ª–∏—Ç—å</button>
          </div>

          <div class="sets"></div>

          <div style="display:flex;gap:10px;margin-top:10px">
            <button class="mini addSet">Ôºã –ü–æ–¥—Ö–æ–¥</button>
          </div>
        `;
        const nameInput = exDiv.querySelector(".name");
        nameInput.addEventListener("input", ()=>{ ex.name = nameInput.value; });

        exDiv.querySelector(".mini.danger").addEventListener("click", ()=>{
          draft.exercises.splice(idx,1);
          renderExercises();
        });

        const setsDiv = exDiv.querySelector(".sets");
        function renderSets(){
          setsDiv.innerHTML = "";
          (ex.sets||[]).forEach((s, sidx)=>{
            const row = document.createElement("div");
            row.className = "setRow";
            row.innerHTML = `
              <input inputmode="decimal" placeholder="–í–µ—Å (–∫–≥)" value="${escapeHtml(s.w ?? "")}">
              <input inputmode="numeric" placeholder="–ü–æ–≤—Ç–æ—Ä—ã" value="${escapeHtml(s.r ?? "")}">
              <button class="delSet" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
            `;
            const wI = row.querySelectorAll("input")[0];
            const rI = row.querySelectorAll("input")[1];
            wI.addEventListener("input", ()=> s.w = wI.value);
            rI.addEventListener("input", ()=> s.r = rI.value);

            row.querySelector(".delSet").addEventListener("click", ()=>{
              ex.sets.splice(sidx,1);
              renderSets();
            });

            setsDiv.appendChild(row);
          });
        }
        renderSets();

        exDiv.querySelector(".addSet").addEventListener("click", ()=>{
          ex.sets.push({w:"", r:""});
          renderSets();
        });

        exList.appendChild(exDiv);
      });
    }

    draftBtn.addEventListener("click", ()=>{
      if(!draft) return;
      draft.title = wTitle.value.trim() || "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞";
      draft.date = wDate.value || selectedDate;

      upsertLocal(draft);
      closeSheetFn();
      selectedDate = draft.date;
      renderWorkouts();
      setTab("workouts");
      toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ ‚úÖ");
    });

    saveBtn.addEventListener("click", ()=>{
      if(!draft) return;
      draft.title = wTitle.value.trim() || "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞";
      draft.date = wDate.value || selectedDate;

      upsertLocal(draft);
      selectedDate = draft.date;
      renderWorkouts();

      // send to bot
      sendToBot(draft);

      closeSheetFn();
      setTab("workouts");
    });

    function upsertLocal(w){
      const i = allWorkouts.findIndex(x=>x.id === w.id);
      if(i >= 0) allWorkouts[i] = w;
      else allWorkouts.push(w);
      saveLocal(allWorkouts);
    }

    function sendToBot(workout){
      const payload = {
        type: "save_workout",
        workout
      };

      if (TG?.sendData) {
        TG.sendData(JSON.stringify(payload));
        toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –±–æ—Ç–∞ üíæ");
      } else {
        toast("TG –Ω–µ –Ω–∞–π–¥–µ–Ω (–æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram). –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ.");
      }
    }

    sendToBotBtn.addEventListener("click", ()=>{
      // –æ—Ç–ø—Ä–∞–≤–∏–º –≤—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É (–∏–ª–∏ –ø–µ—Ä–≤—É—é)
      const todays = workoutsByDate(selectedDate);
      if(!todays.length){
        toast("–ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.");
        return;
      }
      // –æ—Ç–ø—Ä–∞–≤–∏–º –ø–µ—Ä–≤—É—é (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
      sendToBot(todays[0]);
    });

    // Share button ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å–∫–∞–∑–∫–∞
    document.getElementById("shareBtn").addEventListener("click", ()=>{
      toast("–≠–∫—Å–ø–æ—Ä—Ç: –æ—Ç–∫—Ä–æ–π —á–∞—Ç —Å –±–æ—Ç–æ–º –∏ –≤–≤–µ–¥–∏ /export");
    });

    // -----------------------------
    // Calendar screen
    // -----------------------------
    const datePicker = document.getElementById("datePicker");
    const goToDateBtn = document.getElementById("goToDateBtn");

    function syncDatePicker(){
      datePicker.value = selectedDate;
    }
    goToDateBtn.addEventListener("click", ()=>{
      if(datePicker.value){
        selectedDate = datePicker.value;
        renderWorkouts();
        setTab("workouts");
      }
    });

    // -----------------------------
    // Progress screen
    // -----------------------------
    const pDuration = document.getElementById("pDuration");
    const pCount = document.getElementById("pCount");
    const pVolume = document.getElementById("pVolume");
    const chart = document.getElementById("chart");
    const ctx = chart.getContext("2d");

    document.querySelectorAll(".chip").forEach(ch=>{
      ch.addEventListener("click", ()=>{
        document.querySelectorAll(".chip").forEach(x=>x.classList.remove("active"));
        ch.classList.add("active");
        chartRangeDays = Number(ch.dataset.range);
        renderProgress();
      });
    });

    document.getElementById("exportHintBtn").addEventListener("click", ()=>{
      toast("–≠–∫—Å–ø–æ—Ä—Ç: –∫–æ–º–∞–Ω–¥–∞ –±–æ—Ç–∞ /export");
    });

    function renderProgress(){
      const totalCount = allWorkouts.length;
      const totalVolume = allWorkouts.reduce((acc,w)=>acc+calcWorkoutVolume(w),0);
      const estDuration = allWorkouts.reduce((acc,w)=>acc + estimateMinutes(w),0);

      pCount.textContent = totalCount;
      pVolume.textContent = totalVolume;
      pDuration.textContent = estDuration;

      drawChart();
    }

    function estimateMinutes(w){
      // –æ—á–µ–Ω—å –≥—Ä—É–±–æ: 3 –º–∏–Ω –Ω–∞ –ø–æ–¥—Ö–æ–¥
      let sets = 0;
      for(const ex of (w.exercises||[])){
        sets += (ex.sets||[]).length;
      }
      return sets * 3;
    }

    function drawChart(){
      // prepare series per day
      const now = new Date();
      const off = now.getTimezoneOffset();
      const localNow = new Date(now.getTime() - off*60*1000);
      const endISO = localNow.toISOString().slice(0,10);

      let days = chartRangeDays;
      if(days > 3650) days = 3650;

      const end = new Date(endISO + "T00:00:00");
      const start = new Date(end);
      start.setDate(start.getDate() - (days - 1));

      const map = new Map(); // iso -> count
      for(const w of allWorkouts){
        if(!w.date) continue;
        map.set(w.date, (map.get(w.date)||0) + 1);
      }

      const labels = [];
      const values = [];
      const d = new Date(start);
      while(d <= end){
        const iso = d.toISOString().slice(0,10);
        labels.push(iso);
        values.push(map.get(iso) || 0);
        d.setDate(d.getDate() + 1);
      }

      // draw
      const W = chart.width, H = chart.height;
      ctx.clearRect(0,0,W,H);

      // background grid
      ctx.globalAlpha = 1;
      ctx.fillStyle = "rgba(0,0,0,0)";
      ctx.fillRect(0,0,W,H);

      const padding = 28;
      const maxV = Math.max(1, ...values);
      const barW = Math.max(2, Math.floor((W - padding*2) / values.length));

      // axis lines
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 1;
      for(let i=0;i<5;i++){
        const y = padding + (H - padding*2) * (i/4);
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(W-padding, y);
        ctx.stroke();
      }

      // bars
      for(let i=0;i<values.length;i++){
        const v = values[i];
        const x = padding + i*barW;
        const h = (H - padding*2) * (v / maxV);
        const y = H - padding - h;

        // accent-ish without hardcoding: use rgba
        ctx.fillStyle = "rgba(47,124,246,0.85)";
        ctx.fillRect(x, y, barW-1, h);
      }

      // title
      ctx.fillStyle = "rgba(255,255,255,0.8)";
      ctx.font = "bold 14px -apple-system,Segoe UI,Inter,Arial";
      ctx.fillText("–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–Ω—è–º", padding, 18);
    }

    // -----------------------------
    // Settings
    // -----------------------------
    document.getElementById("clearLocalBtn").addEventListener("click", ()=>{
      localStorage.removeItem(LS_KEY);
      allWorkouts = [];
      renderWorkouts();
      renderProgress();
      toast("–õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã üßπ");
    });

    document.getElementById("requestExportBtn").addEventListener("click", ()=>{
      const payload = { type: "request_export" };
      if (TG?.sendData) {
        TG.sendData(JSON.stringify(payload));
        toast("–ó–∞–ø—Ä–æ—Å —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É üì¶");
      } else {
        toast("TG –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Ç–∫—Ä–æ–π –≤ Telegram.");
      }
    });

    // -----------------------------
    // Toast
    // -----------------------------
    let toastT = null;
    function toast(text){
      let el = document.getElementById("toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.style.position = "fixed";
        el.style.left = "50%";
        el.style.bottom = "96px";
        el.style.transform = "translateX(-50%)";
        el.style.background = "rgba(0,0,0,.65)";
        el.style.border = "1px solid rgba(255,255,255,.12)";
        el.style.color = "white";
        el.style.padding = "10px 12px";
        el.style.borderRadius = "14px";
        el.style.fontWeight = "900";
        el.style.fontSize = "13px";
        el.style.boxShadow = "0 12px 26px rgba(0,0,0,.35)";
        el.style.maxWidth = "92vw";
        el.style.textAlign = "center";
        document.body.appendChild(el);
      }
      el.textContent = text;
      el.style.opacity = "1";
      clearTimeout(toastT);
      toastT = setTimeout(()=>{ el.style.opacity="0"; }, 1900);
    }

    // -----------------------------
    // Start
    // -----------------------------
    function init(){
      selectedDate = todayISO();
      renderWorkouts();
      renderProgress();
      syncDatePicker();
      wDate.value = selectedDate;
    }
    init();
  </script>
</body>
</html>
